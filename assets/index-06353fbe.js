var k=Object.defineProperty;var x=(s,e,t)=>e in s?k(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var h=(s,e,t)=>(x(s,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();function S(s,e,t){const o=new Array(s.length);let a=0;for(let i=0;i<t;i+=8)for(let r=0;r<e;r++)o[i*e+r]=s[a++];for(let i=4;i<t;i+=8)for(let r=0;r<e;r++)o[i*e+r]=s[a++];for(let i=2;i<t;i+=4)for(let r=0;r<e;r++)o[i*e+r]=s[a++];for(let i=1;i<t;i+=2)for(let r=0;r<e;r++)o[i*e+r]=s[a++];return o}class E{constructor(e,t){h(this,"data");h(this,"minCodeSize");h(this,"codeSize");h(this,"codeBitMask");h(this,"currentByteIndex",0);h(this,"cache",0);h(this,"cacheCodeSize",0);this.data=e,this.minCodeSize=t,this.resetCodeSize()}resetCodeSize(){this.codeSize=this.minCodeSize+1,this.calculateCodeBitMask()}increaseCodeSize(){this.codeSize++,this.calculateCodeBitMask()}getMaxNumberByCurrentCodeSize(){return Math.pow(2,this.codeSize)-1}calculateCodeBitMask(){this.codeBitMask=2**this.codeSize-1}read(){for(;this.cacheCodeSize<this.codeSize;){if(this.currentByteIndex>=this.data.byteLength)throw new Error("no enough data");this.cache|=this.data[this.currentByteIndex++]<<this.cacheCodeSize,this.cacheCodeSize+=8}const e=this.cache&this.codeBitMask;return this.cache>>=this.codeSize,this.cacheCodeSize-=this.codeSize,e}}const w=(s,e,t)=>{const o=Math.pow(2,12),a=Math.pow(2,s),i=a,r=i+1,l=-1,n=[],c=new E(e,s),p=Array(a).fill(0),d=Array(a).fill(0).map((g,y)=>y);let u=l,f=i+2,m=0,B=0;for(;B<t;){const g=c.read();if(g>f)throw new Error("code bigger than nextKey");if(g===r)break;if(g===i){c.resetCodeSize(),f=i+2,u=l;continue}if(u===l){n.push(g),u=g,m=g,B++;continue}let y=g;const b=[];for(y===f&&(b.push(m),y=u);y>i;)b.push(d[y]),y=p[y];m=d[y],b.push(m),f<o&&(p[f]=u,d[f]=m,f++,f>c.getMaxNumberByCurrentCodeSize()&&f<o&&c.increaseCodeSize()),u=g,n.push(...b.reverse()),B++}return n.push(...Array(t-n.length).fill(0)),n};class D{constructor(e){h(this,"dataArray");h(this,"dataView");h(this,"byteOffset",0);this.dataArray=new Uint8Array(e),this.dataView=new DataView(e)}readByte(){return this.dataArray[this.byteOffset++]}readBytes(e){const t=this.dataArray.slice(this.byteOffset,this.byteOffset+e);return this.byteOffset+=e,t}readChar(){return String.fromCodePoint(this.readByte())}readString(e){return String.fromCodePoint(...this.readBytes(e))}readUint16LE(){const e=this.dataView.getUint16(this.byteOffset,!0);return this.byteOffset+=2,e}peek(e=0){return this.dataArray[this.byteOffset+e]}readHeader(){const e=this.readChar()+this.readChar()+this.readChar();if(e!=="GIF")throw new Error(`invalid signature, got: ${e}`);const t=this.readChar()+this.readChar()+this.readChar();if(t!=="89a")throw new Error(`invalid version, got: ${t}`)}readTrailer(){this.readByte()}readLogicalScreenDescriptor(){const e=this.readUint16LE(),t=this.readUint16LE(),o=this.readByte(),a=o>>7&1,i=o&7,r=this.readByte();return this.readByte(),{width:e,height:t,sizeOfGlobalColorTable:i,backgroundColorIndex:r,globalColorTableFlag:!!a}}readColorTable(e){const t=[];let a=Math.pow(2,e+1);for(;a-- >0;)t.push({r:this.readByte(),g:this.readByte(),b:this.readByte()});return t}readPlainTextExtension(){return this.peek()!==33||this.peek(1)!==1||this.peek(2)!==12?void 0:(this.readByte(),this.readByte(),this.readByte(),this.readBytes(12),{plainTextData:this.readDataSubblocks()})}readApplicationExtension(){if(this.peek()!==33||this.peek(1)!==255||this.peek(2)!==11)return;this.readByte(),this.readByte(),this.readByte();const e=this.readString(8),t=this.readBytes(3),o=this.readDataSubblocks();if(e==="NETSCAPE"&&o.length>0&&o[0].byteLength===3&&o[0][0]===1){const a=o[0][2]<<8||o[0][1];return{key:"NetscapeLoopingApplicationExtension",applitionIdentifier:e,applicationCode:t,loopCount:a}}return{key:"UnkowwnApplicationExtension",applitionIdentifier:e,applicationCode:t}}readDataSubblocks(){const e=[];let t=this.readByte();for(;t!==0;)e.push(this.readBytes(t)),t=this.readByte();return e}readCommentExtension(){return this.peek()!==33||this.peek(1)!==254?void 0:(this.readByte(),this.readByte(),{commentData:this.readDataSubblocks()})}readGraphicControlExtension(){if(this.peek()!==33||this.peek(1)!==249||this.peek(2)!==4)return;this.readByte(),this.readByte(),this.readByte();const e=this.readByte(),t=e>>2&7,o=e&1,a=this.readUint16LE(),i=this.readByte();return this.readByte(),{disposalMethod:t,transparentColorFlag:!!o,delayTime:a,transparentColorIndex:i}}readImageDescriptor(){if(this.peek()!==44)return;this.readByte();const e=this.readUint16LE(),t=this.readUint16LE(),o=this.readUint16LE(),a=this.readUint16LE(),i=this.readByte(),r=i>>7&1,l=i>>6&1,n=i&7;if(r===0&&n!==0)throw new Error(`size of local color table should be 0, got ${n}`);return{top:t,left:e,width:o,height:a,localColorTableFlag:!!r,interlaceFlag:!!l,sizeOfLocalColorTable:n}}readImageData(){const e=this.readByte(),t=[];let o=this.readByte();for(;o!=0;)t.push(this.readBytes(o)),o=this.readByte();return{lzwMinimumCodeSize:e,imageData:new Uint8Array(t.map(a=>[...a]).flat())}}parse(){const{logicalScreen:e,blocks:t}=this.readGifDataStream(),o=[];let a,i;for(const r of t){if(r.key==="SpecialPurposeBlock"){const l=r.value;if(l.key==="ApplicationExtension"){const n=l.value;n.key==="NetscapeLoopingApplicationExtension"&&(a=n.loopCount)}continue}if(r.key==="GraphicBlock"){const l=r.value,n=l.graphicControlExtension,c=l.graphicRenderingBlock;if((c==null?void 0:c.key)==="PlainTextExtension")continue;if(n&&c){const p=c.value;o.push({...n,...p.imageDescriptor,...p.imageData,localColorTable:p.localColorTable}),i=void 0;continue}if(n){i=n;continue}if(c){if(!i)throw new Error("no graphicControlExtension");const p=c.value;o.push({...i,...p.imageDescriptor,...p.imageData,localColorTable:p.localColorTable}),i=void 0;continue}}}return{...e,frames:o,loopCount:a}}readGifDataStream(){this.readHeader();const e=this.readLogicalScreen(),t=[];for(;this.peek()!==0;){const o=this.readData();if(!o)break;t.push(o)}return this.readTrailer(),{logicalScreen:e,blocks:t}}readLogicalScreen(){const e=this.readLogicalScreenDescriptor();let t;return e.globalColorTableFlag&&(t=this.readColorTable(e.sizeOfGlobalColorTable)),{...e,globalColorTable:t}}readData(){const e=this.readGraphicBlock();if(e)return{key:"GraphicBlock",value:e};const t=this.readSpecialPurposeBlock();if(t)return{key:"SpecialPurposeBlock",value:t}}readGraphicBlock(){const e=this.readGraphicControlExtension(),t=this.readGraphicRenderingBlock();if(e||t)return{graphicControlExtension:e,graphicRenderingBlock:t}}readGraphicRenderingBlock(){const e=this.readTableBasedImage();if(e)return{key:"TableBasedImage",value:e};const t=this.readPlainTextExtension();if(t)return{key:"PlainTextExtension",value:t}}readTableBasedImage(){const e=this.readImageDescriptor();if(!e)return;let t;e.localColorTableFlag&&(t=this.readColorTable(e.sizeOfLocalColorTable));const o=this.readImageData();return{imageDescriptor:e,localColorTable:t,imageData:o}}readSpecialPurposeBlock(){const e=this.readApplicationExtension();if(e)return{key:"ApplicationExtension",value:e};const t=this.readCommentExtension();if(t)return{key:"CommentExtension",value:t}}}class T{constructor(e,t){h(this,"loopCount");h(this,"canvas");h(this,"isStoped",!1);h(this,"ctx");h(this,"imageData");this.gif=e,this.container=t,this.loopCount=e.loopCount===0?1/0:e.loopCount===void 0?1:e.loopCount,this.canvas=document.createElement("canvas"),this.canvas.width=e.width,this.canvas.height=e.height,this.ctx=this.canvas.getContext("2d"),this.imageData=this.ctx.getImageData(0,0,this.gif.width,this.gif.height),this.container.appendChild(this.canvas),console.log(e)}play(){this.renderFrame(0)}renderFrame(e){const t=this.gif.frames[e],o=t.localColorTableFlag?t.localColorTable:this.gif.globalColorTable;if(o===void 0)throw new Error("no color table");let a=0;for(let i=t.top;i<t.top+t.height;i++)for(let r=t.left;r<t.left+t.width;r++){const l=i*this.gif.width*4+r*4,n=t.colorIndexes[a++];if(t.transparentColorFlag&&t.transparentColorIndex===n)continue;const{r:c,g:p,b:d}=o[n];this.imageData.data[l]=c,this.imageData.data[l+1]=p,this.imageData.data[l+2]=d,this.imageData.data[l+3]=255}this.ctx.putImageData(this.imageData,0,0),!(this.isStoped||this.loopCount<=0)&&setTimeout(()=>{const i=e+1<this.gif.frames.length?e+1:0;i===this.gif.frames.length-1&&this.loopCount--,this.renderFrame(i)},t.delayTime*10)}}async function C(s){const t=await(await fetch(s)).arrayBuffer(),a=new D(t).parse(),i={...a,frames:a.frames.map(d=>{let u=w(d.lzwMinimumCodeSize,d.imageData,d.width*d.height);return d.interlaceFlag&&(u=S(u,d.width,d.height)),{...d,colorIndexes:u}})};console.log({path:s,gif:a,decodedGif:i});const r=document.querySelector("#app"),l=document.createElement("div"),n=document.createElement("h1");n.innerText=s,l.append(n),r.appendChild(l);const c=document.createElement("img");c.src=s,l.appendChild(c),new T(i,l).play()}async function v(){await C("./demo-1.gif"),await C("./demo-2.gif"),await C("./demo-3.gif"),await C("./demo-4.gif"),await C("./demo-5.gif")}v();
